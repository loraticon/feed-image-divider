<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Notion Image Widget</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    #controls { display: flex; gap: 12px; margin-bottom: 16px; }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
    }
    #addBtn { background: #007BFF; }
    #downloadBtn { background: #28A745; }
    #clearBtn { background: #DC3545; }
    .grid {
      display: grid;
      grid-template-columns: repeat(4,1fr);
      gap: 8px;
    }
    .slot {
      position: relative;
      width: 100%;
      padding-top: 100%;           /* 정사각 유지 */
      border-radius: 12px;
      overflow: hidden;
      background: #eee;
      cursor: pointer;
    }
    .slot img {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      width: 100%; height: 100%;
      object-fit: cover;
      object-position: center;
    }
    /* 팝업용 동일 스타일 (스크립트에서 인라인으로 넣어줍니다) */
  </style>
</head>
<body>
  <div id="controls">
    <button id="addBtn">이미지 추가</button>
    <button id="downloadBtn">다운로드 (원본 크기)</button>
    <button id="clearBtn">전체 비우기</button>
  </div>
  <div class="grid" id="grid"></div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display:none" />

  <!-- 캡처용 라이브러리 -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  (function(){
    const MAX = 8;
    let imgs = [];
    const grid = document.getElementById('grid');
    const fileInput = document.getElementById('fileInput');
    const addBtn = document.getElementById('addBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');

    // 그리드 렌더링
    function renderGrid() {
      grid.innerHTML = '';
      imgs.forEach(src => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        const img = document.createElement('img');
        img.src = src;
        slot.appendChild(img);
        grid.appendChild(slot);
      });
    }

    // 파일 선택 핸들러
    fileInput.addEventListener('change', e => {
      const files = Array.from(e.target.files).slice(0, MAX - imgs.length);
      files.forEach(file => {
        const url = URL.createObjectURL(file);
        imgs.push(url);
      });
      fileInput.value = '';
      renderGrid();
    });

    // 버튼 이벤트
    addBtn.addEventListener('click', () => fileInput.click());
    clearBtn.addEventListener('click', () => {
      if (confirm('정말 모두 삭제하시겠습니까?')) {
        imgs = [];
        renderGrid();
      }
    });

    // 다운로드 (원본 크기 팝업 → 캡처)
    downloadBtn.addEventListener('click', () => {
      if (imgs.length === 0) return alert('먼저 이미지를 추가해주세요.');

      // 팝업 열기
      const popup = window.open('', '_blank');
      const slotSize = 300; // 팝업 내 셀 크기(px) — 원본 해상도에 가깝게 설정
      const bg = '#ffffff'; // 원하시면 #191919 로 다크모드도 적용 가능

      // 팝업 HTML 생성
      const html = `
<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8"/>
<title>캡처 중...</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { padding:20px; background:${bg}; }
  .grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; }
  .slot { position:relative; width:${slotSize}px; padding-top:${slotSize}px; border-radius:12px; overflow:hidden; background:#eee; }
  .slot img { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:contain; object-position:center; }
</style>
</head>
<body>
  <div class="grid">
    ${imgs.map(src => `<div class="slot"><img src="${src}"></div>`).join('')}
  </div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    window.onload = () => {
      const node = document.querySelector('.grid');
      html2canvas(node, { scale: window.devicePixelRatio || 2 })
        .then(canvas => {
          canvas.toBlob(blob => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'notion-widget.png';
            a.click();
            window.close();
          }, 'image/png');
        })
        .catch(err => {
          console.error(err);
          alert('이미지 캡처에 실패했습니다.');
          window.close();
        });
    };
  <\/script>
</body>
</html>`;
      popup.document.write(html);
      popup.document.close();
    });

    renderGrid();
  })();
  </script>
</body>
</html>
