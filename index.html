<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Notion Image Widget</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{padding:20px;background:#f5f5f5;font-family:sans-serif}
    #controls{display:flex;gap:12px;margin-bottom:16px}
    #controls button{padding:8px 16px;border:none;border-radius:6px;color:#fff;cursor:pointer}
    #addBtn{background:#007BFF}
    .bg-btn{background:#6c757d}
    .bg-btn.active{background:#343a40}
    #downloadBtn{background:#28A745}
    #clearBtn{background:#dc3545}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
    .slot{position:relative;width:100%;padding-top:100%;border-radius:12px;overflow:hidden;background:#eee;cursor:pointer}
    .slot img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center}
    .plus{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;color:#aaa;pointer-events:none}
  </style>
</head>
<body>
  <div id="controls">
    <button id="addBtn">이미지 추가</button>
    <button class="bg-btn active" data-color="#ffffff">라이트</button>
    <button class="bg-btn" data-color="#191919">다크</button>
    <button id="downloadBtn">다운로드 (원본 크기)</button>
    <button id="clearBtn">전체 비우기</button>
  </div>
  <div class="grid" id="grid"></div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display:none" />

  <!-- html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
  (function(){
    const MAX = 8;
    let images = [], bgColor = '#ffffff';

    const grid       = document.getElementById('grid');
    const fileInput  = document.getElementById('fileInput');
    const addBtn     = document.getElementById('addBtn');
    const downloadBtn= document.getElementById('downloadBtn');
    const clearBtn   = document.getElementById('clearBtn');
    const bgBtns     = document.querySelectorAll('.bg-btn');

    function renderGrid(){
      grid.innerHTML = '';
      images.forEach(src => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        const img = document.createElement('img');
        img.src = src;
        slot.appendChild(img);
        grid.appendChild(slot);
      });
      if(images.length < MAX){
        const plusSlot = document.createElement('div');
        plusSlot.className = 'slot plus';
        plusSlot.addEventListener('click', ()=> fileInput.click());
        grid.appendChild(plusSlot);
      }
    }

    fileInput.addEventListener('change', e=>{
      Array.from(e.target.files)
        .slice(0, MAX - images.length)
        .forEach(f=> images.push(URL.createObjectURL(f)));
      fileInput.value = '';
      renderGrid();
    });

    addBtn.addEventListener('click', ()=> fileInput.click());
    clearBtn.addEventListener('click', ()=>{
      if(!images.length) return;
      if(confirm('정말 모두 삭제하시겠습니까?')){
        images = [];
        renderGrid();
      }
    });

    bgBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        bgBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        bgColor = btn.dataset.color;
      });
    });

    downloadBtn.addEventListener('click', ()=>{
      if(!images.length){
        return alert('먼저 이미지를 추가해주세요.');
      }
      // 팝업 열기
      const popup = window.open('', '_blank');
      const doc = popup.document;
      doc.open();
      // 최소한의 HTML, 스타일, 스크립트 삽입
      doc.write(`
<!DOCTYPE html><html><head>
<meta charset="UTF-8"/>
<title>캡처 중...</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{padding:20px;background:${bgColor}}
  .grid{display:grid;grid-template-columns:repeat(4,300px);gap:8px}
  .slot{position:relative;width:300px;padding-top:300px;border-radius:12px;overflow:hidden;background:#eee}
  .slot img{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:contain;object-position:center}
</style>
</head><body>
  <div class="grid" id="popGrid"></div>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script>
    const popImages = ${JSON.stringify(images)};
    const popGrid = document.getElementById('popGrid');
    popImages.forEach(src=>{
      const slot = document.createElement('div');
      slot.className = 'slot';
      const img = document.createElement('img');
      img.src = src;
      slot.appendChild(img);
      popGrid.appendChild(slot);
    });
    window.onload = ()=>{
      html2canvas(popGrid, { scale: window.devicePixelRatio||2 })
        .then(canvas=>{
          canvas.toBlob(blob=>{
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'notion-widget.png';
            a.click();
            window.close();
          }, 'image/png');
        })
        .catch(e=>{ console.error(e); window.close(); });
    };
  <\/script>
</body></html>`);
      doc.close();
    });

    renderGrid();
  })();
  </script>
</body>
</html>
