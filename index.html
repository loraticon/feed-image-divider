<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notion Image Widget (PNG Export)</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    #controls { display: flex; gap: 12px; margin-bottom: 16px; }
    button { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; color: #fff; }
    #addBtn { background: #007BFF; }
    .bg-btn { background: #6c757d; }
    .bg-btn.active { background: #343a40; }
    #downloadBtn { background: #28A745; }
    #clearBtn { background: #DC3545; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .slot { position: relative; width: 100%; padding-top: 100%; border-radius: 12px; overflow: hidden; background: #eee; cursor: pointer; }
    .slot img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; object-position: center; }
    .plus { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; color: #aaa; pointer-events: none; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="addBtn">이미지 추가</button>
    <button class="bg-btn active" data-color="#ffffff">라이트</button>
    <button class="bg-btn" data-color="#191919">다크</button>
    <button id="downloadBtn">PNG 다운로드</button>
    <button id="clearBtn">전체 비우기</button>
  </div>
  <div class="grid" id="grid"></div>
  <input type="file" id="fileInput" accept="image/*" multiple style="display:none;">
  <canvas id="exportCanvas" style="display:none;"></canvas>

  <script>
    const MAX = 8;
    let images = [];
    let bgColor = '#ffffff';
    const grid = document.getElementById('grid');
    const fileInput = document.getElementById('fileInput');
    const addBtn = document.getElementById('addBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const clearBtn = document.getElementById('clearBtn');
    const bgBtns = document.querySelectorAll('.bg-btn');
    const exportCanvas = document.getElementById('exportCanvas');

    function renderGrid() {
      grid.innerHTML = '';
      images.forEach(src => {
        const slot = document.createElement('div'); slot.className = 'slot';
        const img = document.createElement('img'); img.src = src;
        slot.appendChild(img);
        grid.appendChild(slot);
      });
      if (images.length < MAX) {
        const plus = document.createElement('div'); plus.className = 'slot plus';
        plus.textContent = '+';
        plus.addEventListener('click', () => fileInput.click());
        grid.appendChild(plus);
      }
    }

    fileInput.addEventListener('change', e => {
      Array.from(e.target.files).slice(0, MAX - images.length).forEach(file => {
        images.push(URL.createObjectURL(file));
      });
      fileInput.value = '';
      renderGrid();
    });

    addBtn.addEventListener('click', () => fileInput.click());
    clearBtn.addEventListener('click', () => {
      if (confirm('정말 모두 삭제하시겠습니까?')) {
        images = [];
        renderGrid();
      }
    });
    bgBtns.forEach(btn => btn.addEventListener('click', () => {
      bgBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      bgColor = btn.dataset.color;
    }));

    downloadBtn.addEventListener('click', () => {
      if (!images.length) return alert('이미지를 먼저 추가해주세요.');
      // 캔버스 크기 설정
      const cols = 4;
      const gap = 8;
      const cell = 150;
      const rows = Math.ceil(images.length / cols);
      const width = cols * cell + (cols - 1) * gap;
      const height = rows * cell + (rows - 1) * gap;
      exportCanvas.width = width;
      exportCanvas.height = height;
      const ctx = exportCanvas.getContext('2d');
      // 배경색
      ctx.fillStyle = bgColor;
      ctx.fillRect(0, 0, width, height);
      // 이미지 그리기
      Promise.all(images.map(src => new Promise(resolve => {
        const img = new Image(); img.onload = () => resolve(img); img.src = src;
      }))).then(imgsArr => {
        imgsArr.forEach((img, i) => {
          const col = i % cols;
          const row = Math.floor(i / cols);
          const x = col * (cell + gap);
          const y = row * (cell + gap);
          // cover
          const scale = Math.max(cell / img.width, cell / img.height);
          const sw = cell / scale;
          const sh = cell / scale;
          const sx = (img.width - sw) / 2;
          const sy = (img.height - sh) / 2;
          ctx.drawImage(img, sx, sy, sw, sh, x, y, cell, cell);
        });
        // PNG 데이터 URL 생성 및 다운로드
        const dataURL = exportCanvas.toDataURL('image/png');
        const a = document.createElement('a');
        a.href = dataURL;
        a.download = 'notion-widget.png';
        a.click();
      });
    });

    renderGrid();
  </script>
</body>
</html>
